<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Idle — Dynamic Home</title>

<!--
  Single-file dynamic background + weather + Spotify now-playing.
  - Weather: Open-Meteo (no API key) via geolocation (fallback coords).
  - Now Playing: tries local websocket agent at ws://localhost:8765 (recommended).
                 Falls back to Spotify Web API if you set SPOTIFY_TOKEN below.
  - Major visual shift every 5 minutes; subtle motion always.
-->

<style>
:root{
  --glass-alpha:0.28;
  --grain-opacity:0.06;
  --accent: 255,100,90;
  --panel-radius:12px;
  --font-sans: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
}
*{box-sizing:border-box}
html,body{height:100%;width:100%;margin:0;background:#000;color:#fff;font-family:var(--font-sans);-webkit-font-smoothing:antialiased;overflow:hidden}
body{display:flex;align-items:center;justify-content:center}

/* full canvas for procedural BG */
#bg-canvas{position:fixed;inset:0;z-index:-3;width:100%;height:100%}

/* moving soft gradient layer & tint (changes per variation) */
.gradient-layer{position:fixed;inset:0;z-index:-2;pointer-events:none;mix-blend-mode:overlay;transition:opacity 900ms ease, filter 1200ms ease}

/* pattern lines overlay for texture */
.pattern-layer{position:fixed;inset:0;z-index:-1;pointer-events:none;background-image:repeating-linear-gradient(90deg, rgba(255,255,255,0.01) 0 1px, transparent 1px 30px);opacity:0.07;transform:translateZ(0);will-change:transform;}

/* grain (subtle) */
.grain{
  position:fixed;inset:0;z-index:0;pointer-events:none;
  background-image:
    url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="64" height="64"><filter id="n"><feTurbulence baseFrequency="0.9" numOctaves="2" stitchTiles="stitch"/></filter><rect width="100%" height="100%" filter="url(%23n)" fill="black"/></svg>');
  mix-blend-mode:overlay;opacity:var(--grain-opacity);
  backdrop-filter: blur(2px);
}

/* HUD cards */
.hud{position:fixed;left:28px;top:36px;display:flex;flex-direction:column;gap:12px;pointer-events:none;z-index:10}
.card{backdrop-filter: blur(14px); background: linear-gradient(180deg, rgba(255,255,255,var(--glass-alpha)), rgba(255,255,255,var(--glass-alpha))); border-radius:var(--panel-radius); padding:10px 12px; min-width:220px; color:rgba(255,255,255,0.95); box-shadow: 0 10px 30px rgba(0,0,0,0.45); pointer-events:auto;}

/* Now Playing compact */
.nowplaying{display:flex;gap:10px;align-items:center}
.art{width:56px;height:56px;border-radius:8px;background:linear-gradient(135deg, rgba(0,0,0,0.35), rgba(255,255,255,0.04));background-size:cover;background-position:center;border:1px solid rgba(255,255,255,0.04)}
.meta{display:flex;flex-direction:column;min-width:0}
.title{font-weight:700;font-size:13px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.artist{font-size:12px;opacity:0.85;margin-top:4px}

/* center info */
.center{
  position:relative; z-index:5; text-align:center; pointer-events:none; user-select:none;
}
.time{font-size:5.6rem;font-weight:300;letter-spacing:2px; margin-bottom:6px; text-shadow: 0 6px 20px rgba(0,0,0,0.6)}
.date{font-size:1.2rem;opacity:0.85;margin-bottom:14px}
.quote{max-width:78%;margin:10px auto;font-size:1.05rem;opacity:0.9;line-height:1.5}

/* small bottom-right extras */
.bottom-right{position:fixed;right:24px;bottom:28px;pointer-events:auto;z-index:10}
.small-card{backdrop-filter: blur(12px); background:linear-gradient(180deg, rgba(255,255,255,var(--glass-alpha)), rgba(255,255,255,var(--glass-alpha))); padding:8px 10px;border-radius:10px;box-shadow:0 8px 22px rgba(0,0,0,0.45);font-size:13px}

/* subtle continuous motion */
@keyframes slowDrift { from{transform:translateY(0) scale(1)} to{transform:translateY(-18px) scale(1.02)} }
.moving { animation: slowDrift 22s ease-in-out infinite alternate; }

/* transition helpers for major shifts */
.shift-fade { transition: opacity 1200ms cubic-bezier(.22,.9,.24,1), transform 1100ms ease; }

/* responsive */
@media (max-width:900px){
  .time{font-size:3.6rem}
  .card{min-width:180px}
}
</style>
</head>
<body>
<canvas id="bg-canvas" aria-hidden="true"></canvas>
<div id="gradient" class="gradient-layer moving shift-fade"></div>
<div class="pattern-layer" id="pattern"></div>
<div class="grain" id="grain"></div>

<div class="hud">
  <div class="card" id="nowcard" role="region" aria-label="Now playing">
    <div class="nowplaying">
      <div class="art" id="np-art" aria-hidden="true"></div>
      <div class="meta">
        <div class="title" id="np-title">Nothing playing</div>
        <div class="artist" id="np-artist">—</div>
      </div>
    </div>
  </div>
  <div class="card small-card" id="weathercard" aria-hidden="true">Loading weather…</div>
</div>

<div class="center">
  <div class="time" id="time">--:--</div>
  <div class="date" id="date">—</div>
  <div class="quote" id="quote">"Simplicity is the ultimate sophistication." —</div>
</div>

<div class="bottom-right">
  <div class="small-card" id="variantLabel">Variation: —</div>
</div>

<script>
/* ---------------------
  CONFIG
  - SPOTIFY_TOKEN: optional; if provided the page will poll Spotify Web API (requires scope user-read-currently-playing).
  - LOCAL_WS: the page attempts a local websocket at ws://localhost:8765 to get now-playing from a local agent (recommended for desktop app).
  --------------------- */
const CONFIG = {
  SPOTIFY_TOKEN: "c55d0b30f34a42a5a31d7bdbcce0c044", // <-- optional: paste a short-lived Spotify access token here if you prefer Web API fallback
  LOCAL_WS: "ws://localhost:8765",
  VARIATION_COUNT: 100,
  MAJOR_SHIFT_INTERVAL_MS: 5 * 60 * 1000 // 5 minutes major shift
};

/* --------------
 Utilities & DOM refs
 -------------- */
const canvas = document.getElementById('bg-canvas');
const ctx = canvas.getContext('2d', {alpha:true});
const gradientEl = document.getElementById('gradient');
const patternEl = document.getElementById('pattern');
const grainEl = document.getElementById('grain');
const npTitle = document.getElementById('np-title');
const npArtist = document.getElementById('np-artist');
const npArt = document.getElementById('np-art');
const variantLabel = document.getElementById('variantLabel');
const weatherCard = document.getElementById('weathercard');
const quoteEl = document.getElementById('quote');

/* responsive canvas */
function resizeCanvas(){
  canvas.width = innerWidth * devicePixelRatio;
  canvas.height = innerHeight * devicePixelRatio;
  canvas.style.width = innerWidth + "px";
  canvas.style.height = innerHeight + "px";
  ctx.setTransform(devicePixelRatio,0,0,devicePixelRatio,0,0);
}
addEventListener('resize', resizeCanvas);
resizeCanvas();

/* -------------------------
 Procedural animated background
 - uses layered noise + smooth blobs (metaballs-ish) rendered in canvas.
 - palette and subtle pattern changes controlled by `variation` index.
 ------------------------- */
let variation = Math.floor(Math.random() * CONFIG.VARIATION_COUNT);
let subtlePhase = 0;

function paletteForVariation(i, weatherCode, hour){
  // make palettes dependent on index, weather, and time-of-day
  const baseHue = (i * 13 + (hour * 7)) % 360;
  let sat = 48 + (i % 24);
  let light = 12 + (i % 18);
  // shift for weather codes: cloudy/cold -> cooler hues; clear -> warmer
  if(weatherCode === 'snow' || weatherCode === 'sleet'){ baseHue = (baseHue + 200) % 360; }
  if(weatherCode === 'rain' || weatherCode === 'thunder'){ baseHue = (baseHue + 160) % 360; sat = Math.max(30, sat-8); }
  if(weatherCode === 'clear'){ light += 8; sat = Math.min(86, sat+6); }
  return {h: baseHue, s: sat, l: light};
}

function hslToRgb(h,s,l){
  // returns [r,g,b]
  s /= 100; l /= 100;
  const k = n => (n + h/30) % 12;
  const a = s * Math.min(l,1-l);
  const f = n => l - a * Math.max(Math.min(k(n)-3, 9-k(n), 1), -1);
  return [Math.round(255*f(0)), Math.round(255*f(8)), Math.round(255*f(4))];
}

function drawBackground(pal){
  // clear
  ctx.clearRect(0,0,innerWidth,innerHeight);
  // draw soft gradient blobs
  const w = innerWidth, h = innerHeight;
  const blobs = 5 + (variation % 6);
  for(let i=0;i<blobs;i++){
    const x = (0.15 + 0.7 * ((i + Math.sin(subtlePhase*0.0008*i)) % 1)) * w;
    const y = (0.25 + 0.6 * ((i * 0.618 + Math.cos(subtlePhase*0.0006*i)) % 1)) * h;
    const radius = Math.max(w,h) * (0.18 + (i%3)*0.07 + ((variation%7)*0.01));
    const grd = ctx.createRadialGradient(x,y, radius*0.05, x,y, radius);
    const color = `rgba(${pal.rgb.join(',')},`;
    grd.addColorStop(0, color + '0.95)');
    grd.addColorStop(0.4, color + '0.45)');
    grd.addColorStop(1, color + '0.02)');
    ctx.globalCompositeOperation = 'lighter';
    ctx.fillStyle = grd;
    ctx.beginPath();
    ctx.arc(x,y,radius,0,Math.PI*2);
    ctx.fill();
  }
  ctx.globalCompositeOperation = 'source-over';
}

/* animate slight movement */
function tick(){
  subtlePhase++;
  // compute palette
  const now = new Date();
  const hour = now.getHours();
  const pal = currentPalette || {h: 0, s: 50, l:20, rgb:[120,40,40]};
  drawBackground(pal);
  // slow transform of pattern element for parallax
  patternEl.style.transform = `translate(${Math.sin(subtlePhase*0.002)*18}px, ${Math.cos(subtlePhase*0.0015)*10}px)`;
  requestAnimationFrame(tick);
}
let currentPalette = null;
requestAnimationFrame(tick);

/* -------------------------
 Variation logic (major shift)
 - applyVariation triggers a smooth shift: changes gradient CSS and palette used by canvas.
 ------------------------- */
function applyVariation(i, weatherCode){
  variation = i % CONFIG.VARIATION_COUNT;
  variantLabel.textContent = `Variation: ${variation+1}`;
  // compute palette
  const now = new Date();
  const pal = paletteForVariation(variation, weatherCode || '', now.getHours());
  pal.rgb = hslToRgb(pal.h, pal.s, pal.l);
  currentPalette = pal;
  // set gradient overlay CSS using palette
  const left = `linear-gradient(120deg, rgba(${pal.rgb.join(',')},0.14), rgba(${Math.floor(pal.rgb[0]*0.7)},${Math.floor(pal.rgb[1]*0.7)},${Math.floor(pal.rgb[2]*0.7)},0.06))`;
  gradientEl.style.background = left;
  gradientEl.style.filter = `blur(${6 + (variation % 8)}px) saturate(${0.9 + (variation%6)/10})`;
  gradientEl.style.opacity = 0.95;
  // tweak pattern opacity/scale
  patternEl.style.opacity = (0.04 + (variation % 6) * 0.01);
  patternEl.style.backgroundSize = `${40 + (variation%30)}px ${40 + (variation%30)}px`;
}

/* auto-cycle everything every 5 minutes (major shift) */
let majorShiftTimer = null;
function startMajorShift(){
  if(majorShiftTimer) clearInterval(majorShiftTimer);
  majorShiftTimer = setInterval(()=>{
    const next = (variation + 1) % CONFIG.VARIATION_COUNT;
    // soft fade for major changes
    gradientEl.style.transition = 'opacity 900ms ease, filter 900ms ease, transform 900ms ease';
    gradientEl.style.opacity = 0;
    setTimeout(()=>{ applyVariation(next, lastWeatherType); gradientEl.style.opacity = 0.95; }, 920);
  }, CONFIG.MAJOR_SHIFT_INTERVAL_MS);
}
startMajorShift();

/* initial apply */
applyVariation(variation);

/* -------------------------
 Weather integration (Open-Meteo)
 - Uses browser geolocation if allowed; else fallback coords.
 - Open-Meteo: free API, no key. (docs: open-meteo.com) :contentReference[oaicite:3]{index=3}
 ------------------------- */
let lastWeatherType = 'clear';
function mapOpenMeteoWeather(code){
  // simplified mapping of weathercode -> friendly type
  // 0: clear, 1-3: partly cloudy/clear, 45-48: fog, 51-67: drizzle/rain, 71-85: snow/sleet, 95-99: thunder
  if(code === 0) return 'clear';
  if(code >= 1 && code <= 3) return 'partly';
  if(code >= 45 && code <= 48) return 'fog';
  if(code >= 51 && code <= 67) return 'rain';
  if(code >= 71 && code <= 86) return 'snow';
  if(code >= 95 && code <= 99) return 'thunder';
  return 'cloudy';
}

function fetchWeather(lat, lon){
  const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current_weather=true`;
  fetch(url).then(r => r.json()).then(data=>{
    if(!data || !data.current_weather) return;
    const cw = data.current_weather;
    const wType = mapOpenMeteoWeather(cw.weathercode);
    lastWeatherType = wType;
    weatherCard.textContent = `${Math.round(cw.temperature)}°C • ${wType}`;
    // nudge a major variation to reflect weather immediately
    applyVariation(variation, wType);
  }).catch(()=>{ weatherCard.textContent = 'Weather unavailable'; });
}

// ask for geolocation, fallback to default (Sydney coords)
if(navigator.geolocation){
  navigator.geolocation.getCurrentPosition(pos => {
    fetchWeather(pos.coords.latitude.toFixed(4), pos.coords.longitude.toFixed(4));
  }, err => {
    // fallback coords
    fetchWeather(-33.8688, 151.2093);
  }, {timeout:8000});
} else {
  fetchWeather(-33.8688, 151.2093);
}

/* -------------------------
 Now Playing (Spotify)
 Strategy:
 1) Try local websocket at CONFIG.LOCAL_WS (recommended) — local agent broadcasts JSON:
    { artist, track, album, art, is_playing }
 2) If not available and CONFIG.SPOTIFY_TOKEN set, poll Spotify Web API endpoint:
    GET https://api.spotify.com/v1/me/player/currently-playing (requires OAuth token & scope). :contentReference[oaicite:4]{index=4}
 3) Otherwise show paused/fallback.
 ------------------------- */

let wsConnected = false;
function connectLocalWs(){
  try{
    const ws = new WebSocket(CONFIG.LOCAL_WS);
    ws.addEventListener('open', ()=>{ wsConnected = true; console.log('local now-playing ws open'); });
    ws.addEventListener('message', ev=>{
      try{
        const msg = JSON.parse(ev.data);
        updateNowPlaying(msg);
      }catch(e){}
    });
    ws.addEventListener('close', ()=>{ wsConnected = false; setTimeout(connectLocalWs, 3000); });
    ws.addEventListener('error', ()=>{ wsConnected = false; ws.close(); });
  }catch(e){
    wsConnected = false;
  }
}
connectLocalWs();

async function pollSpotifyApi(){
  if(!CONFIG.SPOTIFY_TOKEN) return;
  try{
    const res = await fetch('https://api.spotify.com/v1/me/player/currently-playing', {
      headers: { Authorization: 'Bearer ' + CONFIG.SPOTIFY_TOKEN }
    });
    if(res.status === 204){ /* nothing playing */ updateNowPlaying(null); return; }
    if(!res.ok){ console.warn('spotify fetch failed', res.status); return; }
    const data = await res.json();
    const item = data && data.item;
    if(!item){ updateNowPlaying(null); return; }
    const artist = item.artists.map(a=>a.name).join(', ');
    const track = item.name;
    const album = item.album && item.album.name;
    const art = (item.album && item.album.images && item.album.images[0] && item.album.images[0].url) || '';
    updateNowPlaying({artist, track, album, art, is_playing: !data.is_playing?false:true});
  }catch(e){ console.warn('spotify poll error', e); }
}
// poll if token exists
if(CONFIG.SPOTIFY_TOKEN){
  pollSpotifyApi();
  setInterval(pollSpotifyApi, 10000);
}

/* update UI */
function updateNowPlaying(info){
  if(!info){ npTitle.textContent = 'Nothing playing'; npArtist.textContent = '—'; npArt.style.backgroundImage=''; return; }
  npTitle.textContent = info.track || info.title || 'Unknown';
  npArtist.textContent = info.artist || info.album || '';
  if(info.art) npArt.style.backgroundImage = `url('${info.art}')`; else npArt.style.backgroundImage='';
}

/* if neither local ws nor spotify token appears, show nothing; we still keep trying */
setInterval(()=>{ if(!wsConnected && CONFIG.SPOTIFY_TOKEN) pollSpotifyApi(); }, 15_000);

/* -------------------------
 Small UX: randomized quote, initial major shift seed
 ------------------------- */
const quotes = [
  "Simplicity is the ultimate sophistication.",
  "Do one thing well.",
  "Small steps every day.",
  "Focus on what matters.",
  "Elegance is refusal.",
  "Time is what we want most, but use worst.",
  "Design is how it works, not how it looks."
];
quoteEl.textContent = quotes[Math.floor(Math.random() * quotes.length)];

/* time display */
function updateTime(){
  const now = new Date();
  document.getElementById('time').textContent = now.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
  document.getElementById('date').textContent = now.toLocaleDateString([], {weekday:'short', month:'short', day:'numeric'});
}
setInterval(updateTime, 1000);
updateTime();

/* initial palette fetch to avoid blankness */
applyVariation(variation);

/* Expose API for debugging in console */
window.idle = {
  applyVariation, variation, setSpotifyToken: t=>CONFIG.SPOTIFY_TOKEN=t
};
</script>
</body>
</html>
